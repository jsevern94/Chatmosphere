<div id="messages"></div>
<form action="" id="chat">
    <input id="m" autocomplete="off" /><button>Send</button>
</form>
<p class="text-left text-right bg-green-200 bg-blue-200 border-b border-black"></p>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.js"></script>
<script>
    $(document).ready(function () {

        var messages = [];

        var user = '{{{user}}}'

        var partner = '{{{partner}}}'

        getMessages();

        function initializeMessages(arr) {
            for (var i = 0; i < arr.length; i++) {
                if (arr[i].sender.toLowerCase() == user.toLowerCase()) {
                    $('#messages').append($('<div>').text(arr[i].content).addClass('text-right bg-green-200 border-b border-black'));
                }
                else if (arr[i].sender.toLowerCase() == partner.toLowerCase()) {
                    $('#messages').append($('<div>').text(arr[i].content).addClass('text-left bg-blue-200 border-b border-black'));
                }
            }
        }

        function getMessages() {
            $.get("/api/chat/" + partner, function (data) {
                messages = data;
                initializeMessages(messages);
            });
        }

        $(function () {
            var socket = io();
            $('form').submit(function (e) {
                e.preventDefault();
                if ($('#m').val()) {
                    var messageData = {
                        sender: user,
                        receiver: partner,
                        content: $('#m').val().trim(),
                    }

                    socket.emit('chat message', messageData);
                    $.post('/api/messages', messageData);
                    $('#m').val('');
                    return false;
                }
            });
            socket.on('new message', function (msg) {
                if ((msg.sender.toLowerCase() == user.toLowerCase() && msg.receiver.toLowerCase() == partner.toLowerCase())) {
                    $('#messages').append($('<div>').text(msg.content).addClass('text-right bg-green-200 border-b border-black'));
                    window.scrollTo(0, document.body.scrollHeight);
                }
                else if ((msg.sender.toLowerCase() == partner.toLowerCase() && msg.receiver.toLowerCase() == user.toLowerCase())) {
                    $('#messages').append($('<div>').text(msg.content).addClass('text-left bg-blue-200 border-b border-black'));
                    window.scrollTo(0, document.body.scrollHeight);
                }
                if ((msg.sender.toLowerCase() != partner.toLowerCase() && msg.receiver.toLowerCase() == user.toLowerCase())) {
                    showtoast(`You have a new message from ${msg.sender}`, `/chat/${msg.sender}`);
                }
            });
        });
        function ToastBuilder(options) {
            // options are optional
            var opts = options || {};

            // setup some defaults
            opts.defaultText = opts.defaultText || 'default text';
            opts.displayTime = opts.displayTime || 5000;
            opts.target = opts.target || 'body';

            return function (text, link) {
                $('<a>')
                    .attr("href", link)
                    .addClass('toast')
                    .prependTo($(opts.target))
                    .text(text || opts.defaultText)
                    .queue(function (next) {
                        $(this).css({
                            'opacity': 1
                        });
                        var topOffset = 15;
                        $('.toast').each(function () {
                            var $this = $(this);
                            var height = $this.outerHeight();
                            var offset = 15;
                            $this.css('top', topOffset + 'px');

                            topOffset += height + offset;
                        });
                        next();
                    })
                    .delay(opts.displayTime)
                    .queue(function (next) {
                        var $this = $(this);
                        var width = $this.outerWidth() + 20;
                        $this.css({
                            'right': '-' + width + 'px',
                            'opacity': 0
                        });
                        next();
                    })
                    .delay(600)
                    .queue(function (next) {
                        $(this).remove();
                        next();
                    });
            };
        }
        var myOptions = {
            defaultText: 'Toast, yo!',
            displayTime: 3000,
            target: 'body'
        };
        var showtoast = new ToastBuilder(myOptions)
    })
</script>

<style>
    * {
        box-sizing: border-box;
    }

    input {
        outline: none;
    }

    body {
        font-family: "BentonSans", "Helvetica Neue", Helvetica, Arial, Geneva, sans-serif;
        background-color: #3B2F63;
        background-image: -webkit-radial-gradient(50% top, rgba(84, 90, 182, 0.6) 0%, rgba(84, 90, 182, 0) 75%), -webkit-radial-gradient(right top, #794aa2 0%, rgba(121, 74, 162, 0) 57%);
        background-image: radial-gradient(at 50% top, rgba(84, 90, 182, 0.6) 0%, rgba(84, 90, 182, 0) 75%), radial-gradient(at right top, #794aa2 0%, rgba(121, 74, 162, 0) 57%);
        background-repeat: no-repeat;
        background-size: 100% 1000px;
        margin: 0;
        padding: 0;
    }

    .container {
        width: 500px;
        margin: 100px auto;
        background: transparent;
        overflow: hidden;
        border: 2px solid #fff;
        display: flex;
    }

    #toast-btn {
        display: inline-block;
        float: left;
        background: #fff;
        padding: 10px;
        cursor: pointer;
        border: 2px solid #3B2F63;
        white-space: no-wrap;
        font-size: 20px;
        color: #3B2F63;
        width: 40%;
        text-align: center;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    #toast-btn:hover {
        background: #3B2F63;
        color: #fff;
    }

    #textbox {
        background: transparent;
        border: none;
        font-size: 20px;
        padding: 0 10px;
        color: #fff;
        border-left: 2px solid #fff;
        width: 60%;
    }

    .toast {
        padding: 15px 20px;
        color: #fff;
        background: rgba(0, 0, 10, 0.7);
        display: inline-block;
        position: fixed;
        top: -100px;
        right: 15px;
        opacity: 0;
        transition: all 0.4s ease-out;
    }
</style>